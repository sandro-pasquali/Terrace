(function(c){module("basic");function a(d){same(0,d.getLength(),".rows is initialized to an empty array");same(d.getItems().length,0,"getItems().length");same(undefined,d.getIdxById("id"),"getIdxById should return undefined if not found");same(undefined,d.getRowById("id"),"getRowById should return undefined if not found");same(undefined,d.getItemById("id"),"getItemById should return undefined if not found");same(undefined,d.getItemByIdx(0),"getItemByIdx should return undefined if not found")}function b(g,e){e=e||"id";var d=g.getItems(),h=0,j,k;for(var f=0;f<d.length;f++){k=d[f][e];same(g.getItemByIdx(f),d[f],"getItemByIdx");same(g.getItemById(k),d[f],"getItemById");same(g.getIdxById(k),f,"getIdxById");j=g.getRowById(k);if(j===undefined){h++}else{same(g.getItem(j),d[f],"getRowById")}}same(d.length-g.getLength(),h,"filtered rows")}test("initial setup",function(){var d=new Slick.Data.DataView();a(d)});test("initial setup, refresh",function(){var d=new Slick.Data.DataView();d.refresh();a(d)});module("setItems");test("empty",function(){var d=new Slick.Data.DataView();d.setItems([]);a(d)});test("basic",function(){var d=new Slick.Data.DataView();d.setItems([{id:0},{id:1}]);same(2,d.getLength(),"rows.length");same(d.getItems().length,2,"getItems().length");b(d)});test("alternative idProperty",function(){var d=new Slick.Data.DataView();d.setItems([{uid:0},{uid:1}],"uid");b(d,"uid")});test("requires an id on objects",function(){var e=new Slick.Data.DataView();try{e.setItems([1,2,3]);ok(false,"exception expected")}catch(d){}});test("requires a unique id on objects",function(){var e=new Slick.Data.DataView();try{e.setItems([{id:0},{id:0}]);ok(false,"exception expected")}catch(d){}});test("requires a unique id on objects (alternative idProperty)",function(){var e=new Slick.Data.DataView();try{e.setItems([{uid:0},{uid:0}],"uid");ok(false,"exception expected")}catch(d){}});test("events fired on setItems",function(){var e=0;var d=new Slick.Data.DataView();d.onRowsChanged.subscribe(function(g,f){ok(true,"onRowsChanged called");e++});d.onRowCountChanged.subscribe(function(g,f){ok(true,"onRowCountChanged called");same(f.previous,0,"previous arg");same(f.current,2,"current arg");e++});d.onPagingInfoChanged.subscribe(function(g,f){ok(true,"onPagingInfoChanged called");same(f.pageSize,0,"pageSize arg");same(f.pageNum,0,"pageNum arg");same(f.totalRows,2,"totalRows arg");e++});d.setItems([{id:0},{id:1}]);d.refresh();same(3,e,"3 events should have been called")});test("no events on setItems([])",function(){var d=new Slick.Data.DataView();d.onRowsChanged.subscribe(function(){ok(false,"onRowsChanged called")});d.onRowCountChanged.subscribe(function(){ok(false,"onRowCountChanged called")});d.onPagingInfoChanged.subscribe(function(){ok(false,"onPagingInfoChanged called")});d.setItems([]);d.refresh()});test("no events on setItems followed by refresh",function(){var d=new Slick.Data.DataView();d.setItems([{id:0},{id:1}]);d.onRowsChanged.subscribe(function(){ok(false,"onRowsChanged called")});d.onRowCountChanged.subscribe(function(){ok(false,"onRowCountChanged called")});d.onPagingInfoChanged.subscribe(function(){ok(false,"onPagingInfoChanged called")});d.refresh()});test("no refresh while suspended",function(){var d=new Slick.Data.DataView();d.beginUpdate();d.onRowsChanged.subscribe(function(){ok(false,"onRowsChanged called")});d.onRowCountChanged.subscribe(function(){ok(false,"onRowCountChanged called")});d.onPagingInfoChanged.subscribe(function(){ok(false,"onPagingInfoChanged called")});d.setItems([{id:0},{id:1}]);d.setFilter(function(e){return true});d.refresh();same(d.getLength(),0,"rows aren't updated until resumed")});test("refresh fires after resume",function(){var d=new Slick.Data.DataView();d.beginUpdate();d.setItems([{id:0},{id:1}]);same(d.getItems().length,2,"items updated immediately");d.setFilter(function(f){return true});d.refresh();var e=0;d.onRowsChanged.subscribe(function(g,f){ok(true,"onRowsChanged called");same(f,{rows:[0,1]},"args");e++});d.onRowCountChanged.subscribe(function(g,f){ok(true,"onRowCountChanged called");same(f.previous,0,"previous arg");same(f.current,2,"current arg");e++});d.onPagingInfoChanged.subscribe(function(g,f){ok(true,"onPagingInfoChanged called");same(f.pageSize,0,"pageSize arg");same(f.pageNum,0,"pageNum arg");same(f.totalRows,2,"totalRows arg");e++});d.endUpdate();equal(e,3,"events fired");same(d.getItems().length,2,"items are the same");same(d.getLength(),2,"rows updated")});module("sort");test("happy path",function(){var f=0;var d=[{id:2,val:2},{id:1,val:1},{id:0,val:0}];var e=new Slick.Data.DataView();e.setItems(d);e.onRowsChanged.subscribe(function(){ok(true,"onRowsChanged called");f++});e.onRowCountChanged.subscribe(function(){ok(false,"onRowCountChanged called")});e.onPagingInfoChanged.subscribe(function(){ok(false,"onPagingInfoChanged called")});e.sort(function(g,h){return g.val-h.val},true);equal(f,1,"events fired");same(e.getItems(),d,"original array should get sorted");same(d,[{id:0,val:0},{id:1,val:1},{id:2,val:2}],"sort order");b(e)});test("asc by default",function(){var d=[{id:2,val:2},{id:1,val:1},{id:0,val:0}];var e=new Slick.Data.DataView();e.setItems(d);e.sort(function(f,g){return f.val-g.val});same(d,[{id:0,val:0},{id:1,val:1},{id:2,val:2}],"sort order")});test("desc",function(){var d=[{id:0,val:0},{id:2,val:2},{id:1,val:1}];var e=new Slick.Data.DataView();e.setItems(d);e.sort(function(f,g){return -1*(f.val-g.val)});same(d,[{id:2,val:2},{id:1,val:1},{id:0,val:0}],"sort order")});test("sort is stable",function(){var d=[{id:0,val:0},{id:2,val:2},{id:3,val:2},{id:1,val:1}];var e=new Slick.Data.DataView();e.setItems(d);e.sort(function(f,g){return f.val-g.val});same(d,[{id:0,val:0},{id:1,val:1},{id:2,val:2},{id:3,val:2}],"sort order");e.sort(function(f,g){return f.val-g.val});same(d,[{id:0,val:0},{id:1,val:1},{id:2,val:2},{id:3,val:2}],"sorting on the same column again doesn't change the order");e.sort(function(f,g){return -1*(f.val-g.val)});same(d,[{id:2,val:2},{id:3,val:2},{id:1,val:1},{id:0,val:0}],"sort order")});module("filtering");test("applied immediately",function(){var e=0;var d=new Slick.Data.DataView();d.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2}]);d.onRowsChanged.subscribe(function(g,f){ok(true,"onRowsChanged called");same(f,{rows:[0]},"args");e++});d.onRowCountChanged.subscribe(function(g,f){ok(true,"onRowCountChanged called");same(f.previous,3,"previous arg");same(f.current,1,"current arg");e++});d.onPagingInfoChanged.subscribe(function(g,f){ok(true,"onPagingInfoChanged called");same(f.pageSize,0,"pageSize arg");same(f.pageNum,0,"pageNum arg");same(f.totalRows,1,"totalRows arg");e++});d.setFilter(function(f){return f.val===1});equal(e,3,"events fired");same(d.getItems().length,3,"original data is still there");same(d.getLength(),1,"rows are filtered");b(d)});test("re-applied on refresh",function(){var e=0;var d=new Slick.Data.DataView();d.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2}]);d.setFilterArgs(0);d.setFilter(function(g,f){return g.val>=f});same(d.getLength(),3,"nothing is filtered out");b(d);d.onRowsChanged.subscribe(function(g,f){ok(true,"onRowsChanged called");same(f,{rows:[0]},"args");e++});d.onRowCountChanged.subscribe(function(g,f){ok(true,"onRowCountChanged called");same(f.previous,3,"previous arg");same(f.current,1,"current arg");e++});d.onPagingInfoChanged.subscribe(function(g,f){ok(true,"onPagingInfoChanged called");same(f.pageSize,0,"pageSize arg");same(f.pageNum,0,"pageNum arg");same(f.totalRows,1,"totalRows arg");e++});d.setFilterArgs(2);d.refresh();equal(e,3,"events fired");same(d.getItems().length,3,"original data is still there");same(d.getLength(),1,"rows are filtered");b(d)});test("re-applied on sort",function(){var d=new Slick.Data.DataView();d.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2}]);d.setFilter(function(e){return e.val===1});same(d.getLength(),1,"one row is remaining");d.onRowsChanged.subscribe(function(){ok(false,"onRowsChanged called")});d.onRowCountChanged.subscribe(function(){ok(false,"onRowCountChanged called")});d.onPagingInfoChanged.subscribe(function(){ok(false,"onPagingInfoChanged called")});d.sort(function(e,f){return e.val-f.val},false);same(d.getItems().length,3,"original data is still there");same(d.getLength(),1,"rows are filtered");b(d)});test("all",function(){var e=0;var d=new Slick.Data.DataView();d.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2}]);d.onRowsChanged.subscribe(function(g,f){ok(false,"onRowsChanged called")});d.onRowCountChanged.subscribe(function(g,f){ok(true,"onRowCountChanged called");same(f.previous,3,"previous arg");same(f.current,0,"current arg");e++});d.onPagingInfoChanged.subscribe(function(g,f){ok(true,"onPagingInfoChanged called");same(f.pageSize,0,"pageSize arg");same(f.pageNum,0,"pageNum arg");same(f.totalRows,0,"totalRows arg");e++});d.setFilter(function(f){return false});equal(e,2,"events fired");same(d.getItems().length,3,"original data is still there");same(d.getLength(),0,"rows are filtered");b(d)});test("all then none",function(){var e=0;var d=new Slick.Data.DataView();d.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2}]);d.setFilterArgs(false);d.setFilter(function(g,f){return f});same(d.getLength(),0,"all rows are filtered out");d.onRowsChanged.subscribe(function(g,f){ok(true,"onRowsChanged called");same(f,{rows:[0,1,2]},"args");e++});d.onRowCountChanged.subscribe(function(g,f){ok(true,"onRowCountChanged called");same(f.previous,0,"previous arg");same(f.current,3,"current arg");e++});d.onPagingInfoChanged.subscribe(function(g,f){ok(true,"onPagingInfoChanged called");same(f.pageSize,0,"pageSize arg");same(f.pageNum,0,"pageNum arg");same(f.totalRows,3,"totalRows arg");e++});d.setFilterArgs(true);d.refresh();equal(e,3,"events fired");same(d.getItems().length,3,"original data is still there");same(d.getLength(),3,"all rows are back");b(d)});module("updateItem");test("basic",function(){var e=0;var d=new Slick.Data.DataView();d.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2}]);d.onRowsChanged.subscribe(function(g,f){ok(true,"onRowsChanged called");same(f,{rows:[1]},"args");e++});d.onRowCountChanged.subscribe(function(g,f){ok(false,"onRowCountChanged called")});d.onPagingInfoChanged.subscribe(function(g,f){ok(false,"onPagingInfoChanged called")});d.updateItem(1,{id:1,val:1337});equal(e,1,"events fired");same(d.getItem(1),{id:1,val:1337},"item updated");b(d)});test("updating an item not passing the filter",function(){var d=new Slick.Data.DataView();d.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2},{id:3,val:1337}]);d.setFilter(function(e){return e.val!==1337});d.onRowsChanged.subscribe(function(g,f){ok(false,"onRowsChanged called")});d.onRowCountChanged.subscribe(function(g,f){ok(false,"onRowCountChanged called")});d.onPagingInfoChanged.subscribe(function(g,f){ok(false,"onPagingInfoChanged called")});d.updateItem(3,{id:3,val:1337});same(d.getItems()[3],{id:3,val:1337},"item updated");b(d)});test("updating an item to pass the filter",function(){var e=0;var d=new Slick.Data.DataView();d.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2},{id:3,val:1337}]);d.setFilter(function(f){return f.val!==1337});d.onRowsChanged.subscribe(function(g,f){ok(true,"onRowsChanged called");same(f,{rows:[3]},"args");e++});d.onRowCountChanged.subscribe(function(g,f){ok(true,"onRowCountChanged called");equal(f.previous,3,"previous arg");equal(f.current,4,"current arg");e++});d.onPagingInfoChanged.subscribe(function(g,f){ok(true,"onPagingInfoChanged called");same(f.pageSize,0,"pageSize arg");same(f.pageNum,0,"pageNum arg");same(f.totalRows,4,"totalRows arg");e++});d.updateItem(3,{id:3,val:3});equal(e,3,"events fired");same(d.getItems()[3],{id:3,val:3},"item updated");b(d)});test("updating an item to not pass the filter",function(){var e=0;var d=new Slick.Data.DataView();d.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2},{id:3,val:3}]);d.setFilter(function(f){return f.val!==1337});d.onRowsChanged.subscribe(function(g,f){console.log(f);ok(false,"onRowsChanged called")});d.onRowCountChanged.subscribe(function(g,f){ok(true,"onRowCountChanged called");equal(f.previous,4,"previous arg");equal(f.current,3,"current arg");e++});d.onPagingInfoChanged.subscribe(function(g,f){ok(true,"onPagingInfoChanged called");same(f.pageSize,0,"pageSize arg");same(f.pageNum,0,"pageNum arg");same(f.totalRows,3,"totalRows arg");e++});d.updateItem(3,{id:3,val:1337});equal(e,2,"events fired");same(d.getItems()[3],{id:3,val:1337},"item updated");b(d)});module("addItem");test("must have id",function(){var f=0;var e=new Slick.Data.DataView();e.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2}]);try{e.addItem({val:1337});ok(false,"exception thrown")}catch(d){}});test("must have id (custom)",function(){var f=0;var e=new Slick.Data.DataView();e.setItems([{uid:0,val:0},{uid:1,val:1},{uid:2,val:2}],"uid");try{e.addItem({id:3,val:1337});ok(false,"exception thrown")}catch(d){}});test("basic",function(){var e=0;var d=new Slick.Data.DataView();d.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2}]);d.onRowsChanged.subscribe(function(g,f){ok(true,"onRowsChanged called");same(f,{rows:[3]},"args");e++});d.onRowCountChanged.subscribe(function(g,f){ok(true,"onRowCountChanged called");equal(f.previous,3,"previous arg");equal(f.current,4,"current arg");e++});d.onPagingInfoChanged.subscribe(function(g,f){ok(true,"onPagingInfoChanged called");equal(f.pageSize,0,"pageSize arg");equal(f.pageNum,0,"pageNum arg");equal(f.totalRows,4,"totalRows arg");e++});d.addItem({id:3,val:1337});equal(e,3,"events fired");same(d.getItems()[3],{id:3,val:1337},"item updated");same(d.getItem(3),{id:3,val:1337},"item updated");b(d)});test("add an item not passing the filter",function(){var d=new Slick.Data.DataView();d.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2}]);d.setFilter(function(e){return e.val!==1337});d.onRowsChanged.subscribe(function(g,f){ok(false,"onRowsChanged called")});d.onRowCountChanged.subscribe(function(g,f){ok(false,"onRowCountChanged called")});d.onPagingInfoChanged.subscribe(function(g,f){ok(false,"onPagingInfoChanged called")});d.addItem({id:3,val:1337});same(d.getItems()[3],{id:3,val:1337},"item updated");b(d)});module("insertItem");test("must have id",function(){var f=0;var e=new Slick.Data.DataView();e.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2}]);try{e.insertItem(0,{val:1337});ok(false,"exception thrown")}catch(d){}});test("must have id (custom)",function(){var f=0;var e=new Slick.Data.DataView();e.setItems([{uid:0,val:0},{uid:1,val:1},{uid:2,val:2}],"uid");try{e.insertItem(0,{id:3,val:1337});ok(false,"exception thrown")}catch(d){}});test("insert at the beginning",function(){var e=0;var d=new Slick.Data.DataView();d.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2}]);d.onRowsChanged.subscribe(function(g,f){ok(true,"onRowsChanged called");same(f,{rows:[0,1,2,3]},"args");e++});d.onRowCountChanged.subscribe(function(g,f){ok(true,"onRowCountChanged called");equal(f.previous,3,"previous arg");equal(f.current,4,"current arg");e++});d.onPagingInfoChanged.subscribe(function(g,f){ok(true,"onPagingInfoChanged called");equal(f.pageSize,0,"pageSize arg");equal(f.pageNum,0,"pageNum arg");equal(f.totalRows,4,"totalRows arg");e++});d.insertItem(0,{id:3,val:1337});equal(e,3,"events fired");same(d.getItem(0),{id:3,val:1337},"item updated");equal(d.getItems().length,4,"items updated");equal(d.getLength(),4,"rows updated");b(d)});test("insert in the middle",function(){var e=0;var d=new Slick.Data.DataView();d.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2}]);d.onRowsChanged.subscribe(function(g,f){ok(true,"onRowsChanged called");same(f,{rows:[2,3]},"args");e++});d.onRowCountChanged.subscribe(function(g,f){ok(true,"onRowCountChanged called");equal(f.previous,3,"previous arg");equal(f.current,4,"current arg");e++});d.onPagingInfoChanged.subscribe(function(g,f){ok(true,"onPagingInfoChanged called");equal(f.pageSize,0,"pageSize arg");equal(f.pageNum,0,"pageNum arg");equal(f.totalRows,4,"totalRows arg");e++});d.insertItem(2,{id:3,val:1337});equal(e,3,"events fired");same(d.getItem(2),{id:3,val:1337},"item updated");equal(d.getItems().length,4,"items updated");equal(d.getLength(),4,"rows updated");b(d)});test("insert at the end",function(){var e=0;var d=new Slick.Data.DataView();d.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2}]);d.onRowsChanged.subscribe(function(g,f){ok(true,"onRowsChanged called");same(f,{rows:[3]},"args");e++});d.onRowCountChanged.subscribe(function(g,f){ok(true,"onRowCountChanged called");equal(f.previous,3,"previous arg");equal(f.current,4,"current arg");e++});d.onPagingInfoChanged.subscribe(function(g,f){ok(true,"onPagingInfoChanged called");equal(f.pageSize,0,"pageSize arg");equal(f.pageNum,0,"pageNum arg");equal(f.totalRows,4,"totalRows arg");e++});d.insertItem(3,{id:3,val:1337});equal(e,3,"events fired");same(d.getItem(3),{id:3,val:1337},"item updated");equal(d.getItems().length,4,"items updated");equal(d.getLength(),4,"rows updated");b(d)});module("deleteItem");test("must have id",function(){var f=0;var e=new Slick.Data.DataView();e.setItems([{id:0,val:0},{id:1,val:1},{id:2,val:2}]);try{e.deleteItem(-1);ok(false,"exception thrown")}catch(d){}try{e.deleteItem(undefined);ok(false,"exception thrown")}catch(d){}try{e.deleteItem(null);ok(false,"exception thrown")}catch(d){}try{e.deleteItem(3);ok(false,"exception thrown")}catch(d){}});test("must have id (custom)",function(){var f=0;var e=new Slick.Data.DataView();e.setItems([{uid:0,id:-1,val:0},{uid:1,id:3,val:1},{uid:2,id:null,val:2}],"uid");try{e.deleteItem(-1);ok(false,"exception thrown")}catch(d){}try{e.deleteItem(undefined);ok(false,"exception thrown")}catch(d){}try{e.deleteItem(null);ok(false,"exception thrown")}catch(d){}try{e.deleteItem(3);ok(false,"exception thrown")}catch(d){}});test("delete at the beginning",function(){var e=0;var d=new Slick.Data.DataView();d.setItems([{id:5,val:0},{id:15,val:1},{id:25,val:2}]);d.onRowsChanged.subscribe(function(g,f){ok(true,"onRowsChanged called");same(f,{rows:[0,1]},"args");e++});d.onRowCountChanged.subscribe(function(g,f){ok(true,"onRowCountChanged called");equal(f.previous,3,"previous arg");equal(f.current,2,"current arg");e++});d.onPagingInfoChanged.subscribe(function(g,f){ok(true,"onPagingInfoChanged called");equal(f.pageSize,0,"pageSize arg");equal(f.pageNum,0,"pageNum arg");equal(f.totalRows,2,"totalRows arg");e++});d.deleteItem(5);equal(e,3,"events fired");equal(d.getItems().length,2,"items updated");equal(d.getLength(),2,"rows updated");b(d)});test("delete in the middle",function(){var e=0;var d=new Slick.Data.DataView();d.setItems([{id:5,val:0},{id:15,val:1},{id:25,val:2}]);d.onRowsChanged.subscribe(function(g,f){ok(true,"onRowsChanged called");same(f,{rows:[1]},"args");e++});d.onRowCountChanged.subscribe(function(g,f){ok(true,"onRowCountChanged called");equal(f.previous,3,"previous arg");equal(f.current,2,"current arg");e++});d.onPagingInfoChanged.subscribe(function(g,f){ok(true,"onPagingInfoChanged called");equal(f.pageSize,0,"pageSize arg");equal(f.pageNum,0,"pageNum arg");equal(f.totalRows,2,"totalRows arg");e++});d.deleteItem(15);equal(e,3,"events fired");equal(d.getItems().length,2,"items updated");equal(d.getLength(),2,"rows updated");b(d)});test("delete at the end",function(){var e=0;var d=new Slick.Data.DataView();d.setItems([{id:5,val:0},{id:15,val:1},{id:25,val:2}]);d.onRowsChanged.subscribe(function(g,f){ok(false,"onRowsChanged called")});d.onRowCountChanged.subscribe(function(g,f){ok(true,"onRowCountChanged called");equal(f.previous,3,"previous arg");equal(f.current,2,"current arg");e++});d.onPagingInfoChanged.subscribe(function(g,f){ok(true,"onPagingInfoChanged called");equal(f.pageSize,0,"pageSize arg");equal(f.pageNum,0,"pageNum arg");equal(f.totalRows,2,"totalRows arg");e++});d.deleteItem(25);equal(e,2,"events fired");equal(d.getItems().length,2,"items updated");equal(d.getLength(),2,"rows updated");b(d)})})(jQuery);